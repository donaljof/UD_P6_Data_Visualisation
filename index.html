<!DOCTYPE html>
<html>
<head>
 <script src="d3/d3.js"></script>
    <style>

      h1 {
        text-align: center;
        color: black;
        font-family: sans-serif;
        font-variant: arial;
        font-size: 10;
      }

      h2 {
        text-align: center;
        color: blue;
        font-style: italic;
      }

      .axis {
        font-family: arial;
        font-size: 0.6em;
      }
      .path {
        fill: none;
        stroke-width: 2px;        }
      .tick {
        fill: none;
        stroke: black;
      }
  	  circle {
  	    opacity: 0.2;
  	  }
	  circle#line1 {
		fill: green;
	  }
	  circle#line2 {
		fill: red;
	  }
	  circle#line3 {
		fill: blue;
	  }
      #line1 {
        stroke: green;
		color: green;
        font-family: arial;
      }
      #line2 {
        stroke: red;
		color: red;
        font-family: arial;
      }
  	  #line3 {
        stroke: blue;
        color: blue;
        font-family: arial;
      }
      .line_plot {
        fill: none;
        stroke: #4eb0bb;
        stroke-width: 1px;
      }
      .line {
        fill: none;
        stroke: green;
        stroke-width: 2px;
      }
	  rect {
	    fill: red
	  }

    </style>
    <script type="text/javascript">  
    /* insert js here! */
	
    function draw_chart(data) {
		/* main charting function using d3.js */
		// "use strict";

		// Function to filter data down to selected Sex / nationality
		var init_data = data.filter(function(d) { return d['Sex'] === 'Both' && ( d['Nationality'] === 'All' || d['Nationality'] === 'Percentage') });

		var r_axis_data = data.filter(function(d) { return d['Header'] === 'Unemployment' && d['Age.Group'] == '15 - 74 years' && d['Nationality'] === 'Percentage' });


		var margin = {top: 50, right: 100, bottom: 50, left: 100},
		  width = 1000 - margin.left - margin.right,
		  height = 500 - margin.top - margin.bottom;



		var svg = d3.select("body")
		.append("svg")
		.attr("width", width + margin.left + margin.right)
		  .attr("height", height + margin.top + margin.bottom)
		  .append('g')
		  .attr('class', 'chart');


		var year_extent = d3.extent(init_data, function(d) {
		return d['Year'];
		})

		var x_scale = d3.scaleTime()
		  .domain(year_extent)
		  .range([0, width]);

		var x_axis = d3.axisBottom(x_scale);

		var y_extent = d3.extent(init_data, function(d) {
		return d['Result'];
		})

		var y_scale = d3.scaleLinear()
		  .domain(y_extent)
		  .range([height, 0]);

		var y_axis = d3.axisLeft(y_scale)
		.ticks(10);

		// Second y axis on right of graph	
		var y_r_extent = d3.extent(r_axis_data, function(d) {
		return d['Result'];
		})

		var y_r_scale = d3.scaleLinear()
		  .domain(y_r_extent)
		  .range([height, 0]);

		var y_r_axis = d3.axisRight(y_r_scale)
		.ticks(10);

		// Add x axis
		svg.append('g')
		  .attr('class', 'x axis')
			  .attr("transform", "translate(" + margin.left +", "+ (height + margin.top) +")")
		  .call(x_axis)
			  .style("text-anchor", "middle")
			  .attr("font-family","arial");

		// Add y axis
		svg.append('g')
		  .attr('class', 'y axis')
		  .attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
			  .call(y_axis)
		  .append("text")
		  .attr("fill", "#000")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 6)
		  .attr("dy", "0.71em")
		  .attr("text-anchor", "end")
		  .text("Thousand People");

		// add y axis on right hand side	  
		svg.append('g')
		  .attr('class', 'y r axis')
			  .attr("transform", "translate(" + (width + margin.left) + ", " + margin.top + ")")
			.call(y_r_axis)
		  .append("text")
		  .attr("fill", "#000")
		  .attr("transform", "rotate(-90)")
		  .attr("y", -12)
		  .attr("dy", "0.71em")
		  .attr("text-anchor", "end")
		  .text("% Unempolyment");

		var valueline = d3.line()
		  .x(function(d) { return x_scale(d.Year); })
		  .y(function(d) { return y_scale(d.Result); });

		var valueline_right = d3.line()
		  .x(function(d) { return x_scale(d.Year); })
		  .y(function(d) { return y_r_scale(d.Result); });
		  
		debugger;

		//Function to gerate line for each 
		var plot_lines = function(header, index, sex) {

			var line = svg.append('g')
        .attr("id", "line" + index);

			var label_offset = 20 * index

			var line_data = data.filter(function(d) { if (header === 'Unemployment') {
				  return d['Header'] === header && d['Age.Group'] === '15 - 74 years' && d['Sex'] === sex && d['Nationality'] === 'Percentage';
				}else{ 
				  return d['Header'] === header && d['Sex'] === sex && d['Nationality'] === 'All';
				} })

			line.append("text")
				.text(header)
				.attr("transform", "translate(" + 750 + ", " + (margin.top + label_offset) + ")")
				.attr("id", "line" + index);

			line.append('path')
				.attr("class", "line")
				.attr("id", "line" + index)
				.attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
				.attr("d", function(d) {
				  if (header === 'Unemployment') {
					return valueline_right(line_data)
				  }else{
					return valueline(line_data)
				  }});


			line.selectAll("circle")
				.data(line_data)
				.enter()
				.append("circle")
				  .attr("id", "line" + index)
				  .attr("r", 6)
				  .attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
				  .attr("cx", function(d) { return x_scale(d.Year); })
				  .attr("cy", function(d) { if (header === 'Unemployment') {
					  return y_r_scale(d.Result)
					}else{
					  return y_scale(d.Result)
					}});
		}; //plot_lines END

		plot_lines( 'Emmigration', 1, 'Both');
		plot_lines( 'Immigration', 2, 'Both');
		plot_lines( 'Unemployment', 3, 'Both');

    // updater function - should be able to roll this into plot_lines as its similar

    function update_lines(header, index, age_group, sex, nationality) {

		//data for graph, now filtered bu update entered as part of funtion
		var line_data = data.filter(function(d) { if (header === 'Unemployment') {
		  return d['Header'] === header && d['Age.Group'] === age_group && d['Sex'] === sex && ( d['Nationality'] === 'All' || d['Nationality'] === 'Percentage');
		}else{ 
		  return d['Header'] === header && d['Sex'] === sex && d['Nationality'] === nationality;
		} })

		//line id for correct selection
		var linename = 'g#line' + index

		var line = svg.select(linename);

		//update path with new filtered data 
		line.select('path')
			.attr("class", "line")
			.attr("id", "line" + index)
			.attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
			.attr("d", function(d) {
			  if (header === 'Unemployment') {
			  return valueline_right(line_data)
			  }else{
			  return valueline(line_data)
			  }});

		//select circle elements of line x <g>, connect to filtered data and update y
		var circles = line.selectAll("circle")
			.data(line_data)
			.attr("cy", function(d) { if (header === 'Unemployment') {
			  return y_r_scale(d.Result)
			}else{
			  return y_scale(d.Result)
			}});
    }

    // update lines on change of selectbox
    function sexchange() {
      var value = d3.select('select').property('value')
      
      var filtered = data.filter(function(d) {
                  return d['Sex'] === value;
              }); 
      
      update_lines( 'Emmigration', 1, '15 - 74 years', value,'All');
      update_lines( 'Immigration',2,'15 - 74 years', value, 'All');
      update_lines( 'Unemployment',3, '15 - 74 years', value, 'All');
      debugger;
    }
			
		// from http://bl.ocks.org/jfreels/6734823 
		var selectbox = d3.select('body')
			.append('svg')
			.attr("width", width + margin.left + margin.right)
		    .attr("height", "60")
		
		selectbox.append('rect')
			.attr("height", "40")
			.attr("width", "80")
		
		selectbox.append('select')
			.attr('class','select')
			.on('change', sexchange);

		var sex_options = ["Both", "Male", "Female"];

		var options = selectbox.selectAll('option')
			.data(sex_options).enter()
			.append('option')
			.text(function (d) { return d; });


		
		

    }; /* draw_chart END */
	
	function update_data(sex) {
		var new_path = d3.select(path)
	
	}

    function main() {

		var formatYear = d3.timeParse("%Y");

		d3.csv("data/combined_data.csv", function(d) {
			d.Year = formatYear(d.Year);
			d.Result = +d.Result;
			return d;
			}, draw_chart);
	  
    };

    </script>
  </head>
<body>
  <script type="text/javascript">
  /*  call main d3.js script  */
  
  main()

  </script>
<h1>Economic Recession and its Impact on Immigration and Emigration in Ireland (2006 - 2016)</h1>
<h2>Data Visualisation Project - Donal O Farrell</h2>

</body>
</html>
